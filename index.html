<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tetrix</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --vh: 1vh;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: white;
            font-family: 'Orbitron', monospace;
            touch-action: manipulation;
            height: calc(var(--vh, 1vh) * 100);
        }
        
        /* Desktop Layout */
        .desktop-layout {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
        }
        
        .desktop-game-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        .desktop-sidebar-left {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 200px;
        }
        
        .desktop-main {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .desktop-sidebar-right {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 200px;
        }
        
        .desktop-title {
            font-size: 48px;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        .desktop-canvas {
            border: 3px solid #fff;
            background-color: #000;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
        }
        
        .desktop-instructions {
            margin-top: 20px;
            text-align: center;
            font-size: 14px;
            color: #ccc;
        }
        
        .desktop-ui-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff00;
            border-radius: 10px;
            padding: 20px;
        }
        
        .desktop-ui-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .desktop-ui-value {
            color: #00ff00;
            font-weight: 700;
        }
        
        .desktop-next-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .desktop-next-label {
            font-size: 16px;
            margin-bottom: 10px;
            color: #ccc;
        }
        
        .desktop-pause-btn {
            background: linear-gradient(135deg, #ff6600, #ff8800);
            border: 2px solid #ffaa00;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            padding: 12px 20px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .desktop-pause-btn:hover {
            background: linear-gradient(135deg, #ff8800, #ffaa00);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 102, 0, 0.3);
        }
        
        .desktop-pause-btn.paused {
            background: linear-gradient(135deg, #00cc00, #00ff00);
            border-color: #00ff00;
        }
        
        .desktop-sound-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .desktop-sound-btn {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #666;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            padding: 10px 15px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            transition: all 0.3s;
        }
        
        .desktop-sound-btn.active {
            background: rgba(0, 122, 204, 0.8);
            border-color: #007acc;
        }
        
        .desktop-sound-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Mobile Layout - Height Optimized */
        .mobile-layout {
            display: none;
            flex-direction: column;
            height: calc(var(--vh, 1vh) * 100);
            position: relative;
        }
        
        .mobile-title {
            text-align: center;
            font-size: 24px;
            font-weight: 900;
            padding: 8px 0;
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }
        
        .mobile-top-ui {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #00ff00;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .mobile-ui-item {
            text-align: center;
            flex: 1;
        }
        
        .mobile-ui-value {
            color: #00ff00;
            font-size: 14px;
        }
        
        .mobile-game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            position: relative;
            min-height: 0;
        }
        
        .mobile-canvas {
            border: 2px solid #fff;
            background-color: #000;
            max-width: calc(100vw - 20px);
            max-height: 100%;
        }
        
        .mobile-next-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #fff;
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            z-index: 10;
        }
        
        .mobile-next-label {
            font-size: 10px;
            margin-bottom: 3px;
            color: #ccc;
        }
        
        .mobile-pause-btn {
            position: absolute;
            top: 10px;
            right: 50%;
            transform: translateX(50%);
            background: linear-gradient(135deg, #ff6600, #ff8800);
            border: 2px solid #ffaa00;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 700;
            padding: 6px 12px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
            z-index: 20;
        }
        
        .mobile-pause-btn.paused {
            background: linear-gradient(135deg, #00cc00, #00ff00);
            border-color: #00ff00;
        }
        
        .mobile-sound-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 3px;
            z-index: 10;
        }
        
        .mobile-sound-btn {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #666;
            border-radius: 4px;
            color: white;
            font-size: 10px;
            padding: 4px 6px;
            cursor: pointer;
            font-family: 'Orbitron', monospace;
        }
        
        .mobile-sound-btn.active {
            background: rgba(0, 122, 204, 0.8);
            border-color: #007acc;
        }
        
        .mobile-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.9);
            border-top: 2px solid #00ff00;
            height: 100px;
            flex-shrink: 0;
        }
        
        .mobile-control-btn {
            background: linear-gradient(135deg, #333, #555);
            border: 2px solid #666;
            border-radius: 8px;
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            touch-action: manipulation;
        }
        
        .mobile-control-btn:active {
            background: linear-gradient(135deg, #555, #777);
            border-color: #888;
            transform: scale(0.95);
        }
        
        .mobile-control-btn.rotate {
            grid-column: 2;
            grid-row: 1;
            background: linear-gradient(135deg, #0066cc, #0088ff);
            border-color: #00aaff;
        }
        
        .mobile-control-btn.left {
            grid-column: 1;
            grid-row: 2;
        }
        
        .mobile-control-btn.down {
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(135deg, #cc6600, #ff8800);
            border-color: #ffaa00;
        }
        
        .mobile-control-btn.right {
            grid-column: 3;
            grid-row: 2;
        }
        
        /* Pause Screen */
        #pause-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: calc(var(--vh, 1vh) * 100);
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .pause-content {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            border: 3px solid #ffaa00;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 170, 0, 0.5);
            max-width: 90vw;
        }
        
        .pause-title {
            font-family: 'Orbitron', monospace;
            font-size: 36px;
            font-weight: 900;
            color: #ffaa00;
            text-shadow: 0 0 20px rgba(255, 170, 0, 0.8);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }
        
        .pause-instructions {
            font-family: 'Orbitron', monospace;
            font-size: 16px;
            font-weight: 400;
            color: #ffffff;
            margin-bottom: 30px;
        }
        
        .pause-resume-btn {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            color: #000;
            background: linear-gradient(135deg, #00ff00, #00cc00);
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            cursor: pointer;
            text-shadow: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }
        
        .pause-resume-btn:hover {
            background: linear-gradient(135deg, #00cc00, #009900);
            transform: translateY(-2px);
        }
        
        /* Game Over Screen */
        #game-over {
            display: none;
        }
        
        /* Creator Credit */
        .creator-credit {
            /* position: fixed; */
            bottom: 10px;
            /* left: 50%; */
            /* transform: translateX(-50%); */
            font-size: 10px;
            color: #666;
            font-weight: 400;
            z-index: 1000;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 3px 8px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        
        /* Media Queries for Layout Switching */
        @media (max-width: 768px) or (max-height: 600px) {
            .desktop-layout {
                display: none;
            }
            
            .mobile-layout {
                display: flex;
            }
        }
        
        /* Very small screens */
        @media (max-width: 360px) or (max-height: 640px) {
            .mobile-title {
                font-size: 20px;
                padding: 6px 0;
            }
            
            .mobile-top-ui {
                padding: 6px 10px;
                font-size: 11px;
            }
            
            .mobile-ui-value {
                font-size: 13px;
            }
            
            .mobile-controls {
                height: 90px;
                padding: 8px;
                gap: 6px;
            }
            
            .mobile-control-btn {
                font-size: 12px;
            }
            
            .mobile-next-display {
                padding: 4px;
            }
            
            .mobile-next-label {
                font-size: 9px;
            }
            
            .mobile-pause-btn {
                font-size: 11px;
                padding: 5px 10px;
            }
            
            .creator-credit {
                font-size: 9px;
                bottom: 5px;
            }
        }
        
        /* Landscape mode for mobile */
        @media (orientation: landscape) and (max-height: 500px) and (max-width: 768px) {
            .mobile-layout {
                flex-direction: row;
            }
            
            .mobile-title {
                position: absolute;
                top: 0;
                left: 0;
                right: 160px;
                z-index: 15;
                font-size: 16px;
                padding: 4px 0;
            }
            
            .mobile-top-ui {
                position: absolute;
                top: 30px;
                left: 0;
                right: 160px;
                z-index: 10;
                padding: 4px 10px;
            }
            
            .mobile-game-area {
                flex: 1;
                padding: 5px;
                padding-top: 70px;
            }
            
            .mobile-controls {
                width: 160px;
                height: auto;
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr;
                padding: 8px;
            }
            
            .mobile-control-btn.rotate {
                grid-column: 1;
                grid-row: 1;
            }
            
            .mobile-control-btn.left {
                grid-column: 1;
                grid-row: 2;
            }
            
            .mobile-control-btn.down {
                grid-column: 2;
                grid-row: 2;
            }
            
            .mobile-control-btn.right {
                grid-column: 1;
                grid-row: 3;
            }
            
            .mobile-next-display {
                left: 170px;
                top: 5px;
            }
            
            .mobile-sound-controls {
                right: 170px;
                top: 5px;
            }
            
            .mobile-pause-btn {
                right: calc(50% + 80px);
                top: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Desktop Layout -->
    <div class="desktop-layout" id="desktop-layout">
        <div class="desktop-game-container">
            <div class="desktop-sidebar-left">
                <div class="desktop-ui-panel">
                    <div class="desktop-ui-item">
                        <span>SCORE:</span>
                        <span class="desktop-ui-value" id="desktop-score">0</span>
                    </div>
                    <div class="desktop-ui-item">
                        <span>LEVEL:</span>
                        <span class="desktop-ui-value" id="desktop-level">1</span>
                    </div>
                    <div class="desktop-ui-item">
                        <span>LINES:</span>
                        <span class="desktop-ui-value" id="desktop-lines">0</span>
                    </div>
                </div>
                
                <button id="desktop-pause-btn" class="desktop-pause-btn">‚è∏ PAUSE</button>
                
                <div class="desktop-sound-controls">
                    <button id="desktop-sound-toggle" class="desktop-sound-btn active">üîä Sound</button>
                    <button id="desktop-music-toggle" class="desktop-sound-btn active">üéµ Music</button>
                </div>
            </div>
            
            <div class="desktop-main">
                <h1 class="desktop-title">TETRIS</h1>
                <canvas id="desktop-canvas" class="desktop-canvas" width="300" height="600"></canvas>
                <div class="desktop-instructions">
                    <p>Arrow Keys: Move | Space: Rotate | P: Pause | R: Restart</p>
                </div>
            </div>
            
            <div class="desktop-sidebar-right">
                <div class="desktop-next-panel">
                    <div class="desktop-next-label">NEXT PIECE</div>
                    <canvas id="desktop-next-piece" width="120" height="120"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Layout -->
    <div class="mobile-layout" id="mobile-layout">
        <div class="mobile-title">TETRIS</div>
        
        <div class="mobile-top-ui">
            <div class="mobile-ui-item">
                <div>SCORE</div>
                <div class="mobile-ui-value" id="mobile-score">0</div>
            </div>
            <div class="mobile-ui-item">
                <div>LEVEL</div>
                <div class="mobile-ui-value" id="mobile-level">1</div>
            </div>
            <div class="mobile-ui-item">
                <div>LINES</div>
                <div class="mobile-ui-value" id="mobile-lines">0</div>
            </div>
        </div>
        
        <div class="mobile-game-area">
            <canvas id="mobile-canvas" class="mobile-canvas" width="300" height="600"></canvas>
            
            <button id="mobile-pause-btn" class="mobile-pause-btn">‚è∏ PAUSE</button>
            
            <div class="mobile-next-display">
                <div class="mobile-next-label">NEXT</div>
                <canvas id="mobile-next-piece" width="60" height="60"></canvas>
            </div>
            
            <div class="mobile-sound-controls">
                <button id="mobile-sound-toggle" class="mobile-sound-btn active">üîä</button>
                <button id="mobile-music-toggle" class="mobile-sound-btn active">üéµ</button>
            </div>
        </div>
        
        <div class="mobile-controls">
            <button class="mobile-control-btn rotate" id="mobile-rotate-btn">‚Üª</button>
            <button class="mobile-control-btn left" id="mobile-left-btn">‚Üê</button>
            <button class="mobile-control-btn down" id="mobile-down-btn">‚Üì</button>
            <button class="mobile-control-btn right" id="mobile-right-btn">‚Üí</button>
        </div>
    </div>
    
    <!-- Pause Screen -->
    <div id="pause-screen">
        <div class="pause-content">
            <div class="pause-title">PAUSED</div>
            <div class="pause-instructions">Game is paused. Click resume to continue.</div>
            <button id="pause-resume-btn" class="pause-resume-btn">‚ñ∂ RESUME</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="game-over"></div>
    
    <!-- Creator Credit -->
    <div class="creator-credit">Created by Cephas Weror</div>

    <script>
        // Fix viewport height issues on mobile
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        // Set initial viewport height
        setViewportHeight();
        
        // Update on resize and orientation change
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', () => {
            setTimeout(setViewportHeight, 100);
        });
        
        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // Viewport detection
        function isMobileViewport() {
            return window.innerWidth <= 768 || window.innerHeight <= 600;
        }
        
        // Game constants
        const GRID_WIDTH = 10;
        const GRID_HEIGHT = 20;
        let BLOCK_SIZE = 25;
        
        // Adjust game size based on viewport with better mobile optimization
        function adjustGameSize() {
            const isMobile = isMobileViewport();
            let canvas, gameArea;
            
            if (isMobile) {
                canvas = document.getElementById('mobile-canvas');
                gameArea = document.querySelector('.mobile-game-area');
                
                if (gameArea && canvas) {
                    // Calculate available space more precisely for mobile
                    const viewportHeight = window.innerHeight;
                    const titleHeight = document.querySelector('.mobile-title')?.offsetHeight || 40;
                    const topUIHeight = document.querySelector('.mobile-top-ui')?.offsetHeight || 50;
                    const controlsHeight = document.querySelector('.mobile-controls')?.offsetHeight || 100;
                    const padding = 20;
                    
                    const availableHeight = viewportHeight - titleHeight - topUIHeight - controlsHeight - padding;
                    const availableWidth = Math.min(window.innerWidth - 20, 350);
                    
                    // Calculate optimal block size
                    const blockSizeByWidth = Math.floor(availableWidth / GRID_WIDTH);
                    const blockSizeByHeight = Math.floor(availableHeight / GRID_HEIGHT);
                    BLOCK_SIZE = Math.min(blockSizeByWidth, blockSizeByHeight, 28);
                    BLOCK_SIZE = Math.max(BLOCK_SIZE, 15); // Minimum size
                    
                    canvas.width = GRID_WIDTH * BLOCK_SIZE;
                    canvas.height = GRID_HEIGHT * BLOCK_SIZE;
                }
            } else {
                canvas = document.getElementById('desktop-canvas');
                BLOCK_SIZE = 30;
                canvas.width = GRID_WIDTH * BLOCK_SIZE;
                canvas.height = GRID_HEIGHT * BLOCK_SIZE;
            }
        }
        
        // Sound system
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.soundEnabled = true;
                this.musicEnabled = true;
                this.musicPlaying = false;
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('Web Audio API not supported');
                }
            }

            playTone(frequency, duration, type = 'sine', volume = 0.1) {
                if (!this.soundEnabled || !this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playMove() { this.playTone(200, 0.1, 'square', 0.05); }
            playRotate() { this.playTone(300, 0.15, 'sawtooth', 0.08); }
            playDrop() { this.playTone(150, 0.2, 'triangle', 0.1); }
            
            playLineClear() {
                setTimeout(() => this.playTone(523, 0.15, 'sine', 0.15), 0);
                setTimeout(() => this.playTone(659, 0.15, 'sine', 0.15), 100);
                setTimeout(() => this.playTone(784, 0.15, 'sine', 0.15), 200);
                setTimeout(() => this.playTone(1047, 0.3, 'sine', 0.15), 300);
            }

            playTetris() {
                const notes = [523, 659, 784, 1047, 1319];
                notes.forEach((note, i) => {
                    setTimeout(() => this.playTone(note, 0.2, 'sine', 0.2), i * 80);
                });
            }

            playGameOver() {
                const notes = [523, 494, 440, 392, 349, 294, 262];
                notes.forEach((note, i) => {
                    setTimeout(() => this.playTone(note, 0.3, 'triangle', 0.15), i * 150);
                });
            }

            playLevelUp() {
                setTimeout(() => this.playTone(392, 0.1, 'sine', 0.12), 0);
                setTimeout(() => this.playTone(523, 0.1, 'sine', 0.12), 100);
                setTimeout(() => this.playTone(659, 0.2, 'sine', 0.12), 200);
            }

            startBackgroundMusic() {
                if (!this.musicEnabled || !this.audioContext) return;
                this.musicPlaying = true;
                this.playBackgroundLoop();
            }

            playBackgroundLoop() {
                if (!this.musicEnabled || !this.musicPlaying) return;
                
                const melody = [
                    {note: 659, duration: 0.4}, {note: 523, duration: 0.2},
                    {note: 587, duration: 0.2}, {note: 659, duration: 0.2},
                    {note: 587, duration: 0.2}, {note: 523, duration: 0.2},
                    {note: 440, duration: 0.4}, {note: 440, duration: 0.2},
                    {note: 523, duration: 0.2}, {note: 659, duration: 0.4},
                    {note: 587, duration: 0.2}, {note: 523, duration: 0.2},
                    {note: 494, duration: 0.6}, {note: 494, duration: 0.2}
                ];

                let currentTime = 0;
                const volume = isMobileViewport() ? 0.015 : 0.03;
                melody.forEach(({note, duration}) => {
                    setTimeout(() => {
                        if (this.musicEnabled && this.musicPlaying) {
                            this.playTone(note, duration * 0.8, 'sine', volume);
                        }
                    }, currentTime * 1000);
                    currentTime += duration;
                });

                if (this.musicEnabled && this.musicPlaying) {
                    setTimeout(() => this.playBackgroundLoop(), currentTime * 1000 + 2000);
                }
            }

            stopMusic() { this.musicPlaying = false; }
            
            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                return this.soundEnabled;
            }

            toggleMusic() {
                this.musicEnabled = !this.musicEnabled;
                if (this.musicEnabled) {
                    this.musicPlaying = true;
                    setTimeout(() => this.startBackgroundMusic(), 1000);
                } else {
                    this.stopMusic();
                }
                return this.musicEnabled;
            }
        }
        
        // Tetromino definitions
        const TETROMINOES = {
            I: { shape: [[1, 1, 1, 1]], color: '#00FFFF' },
            O: { shape: [[1, 1], [1, 1]], color: '#FFFF00' },
            T: { shape: [[0, 1, 0], [1, 1, 1]], color: '#800080' },
            J: { shape: [[1, 0, 0], [1, 1, 1]], color: '#0000FF' },
            L: { shape: [[0, 0, 1], [1, 1, 1]], color: '#FF8000' },
            S: { shape: [[0, 1, 1], [1, 1, 0]], color: '#00FF00' },
            Z: { shape: [[1, 1, 0], [0, 1, 1]], color: '#FF0000' }
        };

        class Tetromino {
            constructor(type, x = 0, y = 0) {
                this.type = type;
                this.shape = JSON.parse(JSON.stringify(TETROMINOES[type].shape));
                this.color = TETROMINOES[type].color;
                this.x = x;
                this.y = y;
            }

            rotate() {
                const rows = this.shape.length;
                const cols = this.shape[0].length;
                const rotated = [];
                
                for (let i = 0; i < cols; i++) {
                    rotated[i] = [];
                    for (let j = 0; j < rows; j++) {
                        rotated[i][j] = this.shape[rows - 1 - j][i];
                    }
                }
                this.shape = rotated;
            }

            getBlocks() {
                const blocks = [];
                for (let row = 0; row < this.shape.length; row++) {
                    for (let col = 0; col < this.shape[row].length; col++) {
                        if (this.shape[row][col]) {
                            blocks.push({
                                x: this.x + col,
                                y: this.y + row,
                                color: this.color
                            });
                        }
                    }
                }
                return blocks;
            }
        }

        class TetrisGame {
            constructor() {
                this.isMobile = isMobileViewport();
                adjustGameSize();
                
                // Set up canvas references based on viewport
                if (this.isMobile) {
                    this.canvas = document.getElementById('mobile-canvas');
                    this.nextCanvas = document.getElementById('mobile-next-piece');
                } else {
                    this.canvas = document.getElementById('desktop-canvas');
                    this.nextCanvas = document.getElementById('desktop-next-piece');
                }
                
                this.ctx = this.canvas.getContext('2d');
                this.nextCtx = this.nextCanvas.getContext('2d');
                this.soundSystem = new SoundSystem();
                
                this.initializeGame();
                this.setupControls();
                this.setupSoundControls();
                this.gameLoop();
                
                // Handle viewport changes with debouncing
                let resizeTimeout;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(() => {
                        const newIsMobile = isMobileViewport();
                        if (newIsMobile !== this.isMobile) {
                            location.reload();
                        } else {
                            adjustGameSize();
                            this.render();
                        }
                    }, 250);
                });
                
                // Start background music
                setTimeout(() => this.soundSystem.startBackgroundMusic(), 2000);
            }

            setupControls() {
                if (this.isMobile) {
                    this.setupMobileControls();
                } else {
                    this.setupDesktopControls();
                }
                this.setupPauseControls();
            }

            setupMobileControls() {
                const leftBtn = document.getElementById('mobile-left-btn');
                const rightBtn = document.getElementById('mobile-right-btn');
                const downBtn = document.getElementById('mobile-down-btn');
                const rotateBtn = document.getElementById('mobile-rotate-btn');

                [leftBtn, rightBtn, downBtn, rotateBtn].forEach(btn => {
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        btn.style.transform = 'scale(0.95)';
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        btn.style.transform = 'scale(1)';
                    });
                });

                leftBtn.addEventListener('touchstart', () => this.handleMove(-1, 0));
                rightBtn.addEventListener('touchstart', () => this.handleMove(1, 0));
                downBtn.addEventListener('touchstart', () => this.handleMove(0, 1));
                rotateBtn.addEventListener('touchstart', () => this.handleRotate());
            }

            setupDesktopControls() {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'r' || e.key === 'R') {
                        if (this.gameOver) {
                            this.restart();
                        }
                        return;
                    }
                    if (e.key === 'p' || e.key === 'P') {
                        this.togglePause();
                        return;
                    }
                    if (this.gameOver || this.paused) return;

                    switch(e.key) {
                        case 'ArrowLeft': this.handleMove(-1, 0); break;
                        case 'ArrowRight': this.handleMove(1, 0); break;
                        case 'ArrowDown': this.handleMove(0, 1); break;
                        case ' ': this.handleRotate(); break;
                    }
                    e.preventDefault();
                });
            }

            setupPauseControls() {
                const prefix = this.isMobile ? 'mobile' : 'desktop';
                const pauseBtn = document.getElementById(`${prefix}-pause-btn`);
                const resumeBtn = document.getElementById('pause-resume-btn');

                pauseBtn.addEventListener('click', () => {
                    this.togglePause();
                });

                resumeBtn.addEventListener('click', () => {
                    this.togglePause();
                });
            }

            togglePause() {
                if (this.gameOver) return;
                
                this.paused = !this.paused;
                const prefix = this.isMobile ? 'mobile' : 'desktop';
                const pauseBtn = document.getElementById(`${prefix}-pause-btn`);
                
                if (this.paused) {
                    pauseBtn.textContent = '‚ñ∂Ô∏è RESUME';
                    pauseBtn.classList.add('paused');
                    document.getElementById('pause-screen').style.display = 'flex';
                    this.soundSystem.stopMusic();
                } else {
                    pauseBtn.textContent = '‚è∏Ô∏è PAUSE';
                    pauseBtn.classList.remove('paused');
                    document.getElementById('pause-screen').style.display = 'none';
                    if (this.soundSystem.musicEnabled) {
                        setTimeout(() => this.soundSystem.startBackgroundMusic(), 500);
                    }
                }
            }

            handleMove(dx, dy) {
                if (this.gameOver || this.paused) return;
                if (this.movePiece(dx, dy)) {
                    this.soundSystem.playMove();
                }
            }

            handleRotate() {
                if (this.gameOver || this.paused) return;
                const originalShape = JSON.parse(JSON.stringify(this.currentPiece.shape));
                this.currentPiece.rotate();
                
                if (this.isValidPosition(this.currentPiece.shape, this.currentPiece.x, this.currentPiece.y)) {
                    this.soundSystem.playRotate();
                } else {
                    this.currentPiece.shape = originalShape;
                }
            }

            setupSoundControls() {
                const prefix = this.isMobile ? 'mobile' : 'desktop';
                const soundToggle = document.getElementById(`${prefix}-sound-toggle`);
                const musicToggle = document.getElementById(`${prefix}-music-toggle`);

                soundToggle.addEventListener('click', () => {
                    const enabled = this.soundSystem.toggleSound();
                    if (this.isMobile) {
                        soundToggle.textContent = enabled ? 'üîä' : 'üîá';
                    } else {
                        soundToggle.textContent = enabled ? 'üîä Sound' : 'üîá Sound';
                    }
                    soundToggle.className = enabled ? `${prefix}-sound-btn active` : `${prefix}-sound-btn`;
                });

                musicToggle.addEventListener('click', () => {
                    const enabled = this.soundSystem.toggleMusic();
                    if (this.isMobile) {
                        musicToggle.textContent = enabled ? 'üéµ' : 'üéµ';
                    } else {
                        musicToggle.textContent = enabled ? 'üéµ Music' : 'üéµ Music';
                    }
                    musicToggle.className = enabled ? `${prefix}-sound-btn active` : `${prefix}-sound-btn`;
                });
            }

            initializeGame() {
                this.grid = Array(GRID_HEIGHT).fill().map(() => Array(GRID_WIDTH).fill(null));
                this.score = 0;
                this.level = 1;
                this.linesCleared = 0;
                this.gameOver = false;
                this.paused = false;
                this.dropTime = 0;
                this.dropInterval = 1000;

                this.currentPiece = this.getRandomTetromino();
                this.nextPiece = this.getRandomTetromino();

                this.updateUI();
                document.getElementById('game-over').style.display = 'none';
                document.getElementById('game-over').innerHTML = '';
                document.getElementById('pause-screen').style.display = 'none';
            }

            getRandomTetromino() {
                const types = Object.keys(TETROMINOES);
                const randomType = types[Math.floor(Math.random() * types.length)];
                return new Tetromino(randomType, Math.floor(GRID_WIDTH / 2) - 1, 0);
            }

            movePiece(dx, dy) {
                const newX = this.currentPiece.x + dx;
                const newY = this.currentPiece.y + dy;
                
                if (this.isValidPosition(this.currentPiece.shape, newX, newY)) {
                    this.currentPiece.x = newX;
                    this.currentPiece.y = newY;
                    return true;
                }
                return false;
            }

            isValidPosition(shape, x, y) {
                for (let row = 0; row < shape.length; row++) {
                    for (let col = 0; col < shape[row].length; col++) {
                        if (shape[row][col]) {
                            const newX = x + col;
                            const newY = y + row;
                            
                            if (newX < 0 || newX >= GRID_WIDTH || newY >= GRID_HEIGHT) {
                                return false;
                            }
                            
                            if (newY >= 0 && this.grid[newY][newX]) {
                                return false;
                            }
                        }
                    }
                }
                return true;
            }

            placePiece() {
                const blocks = this.currentPiece.getBlocks();
                blocks.forEach(block => {
                    if (block.y >= 0 && block.y < GRID_HEIGHT && block.x >= 0 && block.x < GRID_WIDTH) {
                        this.grid[block.y][block.x] = block.color;
                    }
                });
                this.soundSystem.playDrop();
            }

            clearLines() {
                let linesCleared = 0;
                
                for (let row = GRID_HEIGHT - 1; row >= 0; row--) {
                    if (this.grid[row].every(cell => cell !== null)) {
                        this.grid.splice(row, 1);
                        this.grid.unshift(new Array(GRID_WIDTH).fill(null));
                        linesCleared++;
                        row++;
                    }
                }
                
                if (linesCleared > 0) {
                    if (linesCleared === 4) {
                        this.soundSystem.playTetris();
                    } else {
                        this.soundSystem.playLineClear();
                    }

                    this.linesCleared += linesCleared;
                    this.score += linesCleared * 100 * this.level;
                    
                    const newLevel = Math.floor(this.linesCleared / 10) + 1;
                    if (newLevel > this.level) {
                        this.level = newLevel;
                        this.dropInterval = Math.max(200, 1000 - (this.level - 1) * 80);
                        this.soundSystem.playLevelUp();
                    }
                    
                    this.updateUI();
                }
            }

            spawnNewPiece() {
                this.currentPiece = this.nextPiece;
                this.currentPiece.x = Math.floor(GRID_WIDTH / 2) - 1;
                this.currentPiece.y = 0;
                this.nextPiece = this.getRandomTetromino();
                
                if (!this.isValidPosition(this.currentPiece.shape, this.currentPiece.x, this.currentPiece.y)) {
                    this.gameOver = true;
                    this.soundSystem.stopMusic();
                    this.soundSystem.playGameOver();
                    this.showGameOverScreen();
                }
            }

            showGameOverScreen() {
                const gameOverDiv = document.getElementById('game-over');
                const restartText = this.isMobile ? 'TAP TO RESTART' : 'PRESS R TO RESTART';
                
                gameOverDiv.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100vw;
                        height: calc(var(--vh, 1vh) * 100);
                        background-color: rgba(0, 0, 0, 0.9);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    ">
                        <div style="
                            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
                            border: 3px solid #ff0000;
                            border-radius: 15px;
                            padding: ${this.isMobile ? '25px' : '40px'};
                            text-align: center;
                            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
                            max-width: 90vw;
                        ">
                            <div style="
                                font-family: 'Orbitron', monospace;
                                font-size: ${this.isMobile ? '28px' : '48px'};
                                font-weight: 900;
                                color: #ff0000;
                                text-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
                                margin-bottom: 20px;
                                letter-spacing: 2px;
                            ">GAME OVER</div>
                            <div style="
                                font-family: 'Orbitron', monospace;
                                font-size: ${this.isMobile ? '16px' : '24px'};
                                font-weight: 400;
                                color: #ffffff;
                                margin-bottom: 10px;
                            ">Score: ${this.score}</div>
                            <div style="
                                font-family: 'Orbitron', monospace;
                                font-size: ${this.isMobile ? '12px' : '18px'};
                                font-weight: 400;
                                color: #cccccc;
                                margin-bottom: 30px;
                            ">Level: ${this.level} | Lines: ${this.linesCleared}</div>
                            ${this.isMobile ? `
                                <button onclick="game.restart()" style="
                                    font-family: 'Orbitron', monospace;
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #000;
                                    background: linear-gradient(135deg, #00ff00, #00cc00);
                                    border: none;
                                    border-radius: 8px;
                                    padding: 12px 24px;
                                    cursor: pointer;
                                    text-shadow: none;
                                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                                ">RESTART</button>
                            ` : `
                                <div style="
                                    font-family: 'Orbitron', monospace;
                                    font-size: 20px;
                                    font-weight: 700;
                                    color: #00ff00;
                                    text-shadow: 0 0 10px rgba(0, 255, 0, 0.6);
                                    animation: blink 1.5s infinite;
                                ">${restartText}</div>
                            `}
                        </div>
                    </div>
                    <style>
                        @keyframes blink {
                            0%, 50% { opacity: 1; }
                            51%, 100% { opacity: 0.3; }
                        }
                    </style>
                `;
                gameOverDiv.style.display = 'block';
            }

            updateUI() {
                const prefix = this.isMobile ? 'mobile' : 'desktop';
                document.getElementById(`${prefix}-score`).textContent = this.score;
                document.getElementById(`${prefix}-level`).textContent = this.level;
                document.getElementById(`${prefix}-lines`).textContent = this.linesCleared;
            }

            drawBlock(ctx, x, y, color) {
                ctx.fillStyle = color;
                ctx.fillRect(x, y, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, BLOCK_SIZE - 1, BLOCK_SIZE - 1);
            }

            drawGrid() {
                this.ctx.strokeStyle = '#333';
                this.ctx.lineWidth = 1;
                
                for (let i = 0; i <= GRID_WIDTH; i++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(i * BLOCK_SIZE, 0);
                    this.ctx.lineTo(i * BLOCK_SIZE, GRID_HEIGHT * BLOCK_SIZE);
                    this.ctx.stroke();
                }
                
                for (let i = 0; i <= GRID_HEIGHT; i++) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, i * BLOCK_SIZE);
                    this.ctx.lineTo(GRID_WIDTH * BLOCK_SIZE, i * BLOCK_SIZE);
                    this.ctx.stroke();
                }
            }

            render() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawGrid();
                
                // Draw placed blocks
                for (let row = 0; row < GRID_HEIGHT; row++) {
                    for (let col = 0; col < GRID_WIDTH; col++) {
                        if (this.grid[row][col]) {
                            this.drawBlock(this.ctx, col * BLOCK_SIZE, row * BLOCK_SIZE, this.grid[row][col]);
                        }
                    }
                }
                
                // Draw current piece
                if (!this.gameOver && this.currentPiece) {
                    const blocks = this.currentPiece.getBlocks();
                    blocks.forEach(block => {
                        if (block.y >= 0) {
                            this.drawBlock(this.ctx, block.x * BLOCK_SIZE, block.y * BLOCK_SIZE, block.color);
                        }
                    });
                }
                
                this.renderNextPiece();
            }

            renderNextPiece() {
                this.nextCtx.clearRect(0, 0, this.nextCanvas.width, this.nextCanvas.height);
                
                if (this.nextPiece) {
                    const blocks = this.nextPiece.getBlocks();
                    
                    let minX = Math.min(...blocks.map(b => b.x));
                    let maxX = Math.max(...blocks.map(b => b.x));
                    let minY = Math.min(...blocks.map(b => b.y));
                    let maxY = Math.max(...blocks.map(b => b.y));
                    
                    const blockSize = this.isMobile ? 12 : 20;
                    const pieceWidth = (maxX - minX + 1) * blockSize;
                    const pieceHeight = (maxY - minY + 1) * blockSize;
                    
                    const offsetX = (this.nextCanvas.width - pieceWidth) / 2;
                    const offsetY = (this.nextCanvas.height - pieceHeight) / 2;
                    
                    blocks.forEach(block => {
                        const x = offsetX + (block.x - minX) * blockSize;
                        const y = offsetY + (block.y - minY) * blockSize;
                        this.nextCtx.fillStyle = block.color;
                        this.nextCtx.fillRect(x, y, blockSize - 2, blockSize - 2);
                        this.nextCtx.strokeStyle = '#fff';
                        this.nextCtx.strokeRect(x, y, blockSize - 2, blockSize - 2);
                    });
                }
            }

            update() {
                if (this.gameOver || this.paused) return;
                
                this.dropTime += 16;
                if (this.dropTime >= this.dropInterval) {
                    this.dropTime = 0;
                    if (!this.movePiece(0, 1)) {
                        this.placePiece();
                        this.clearLines();
                        this.spawnNewPiece();
                    }
                }
            }

            gameLoop() {
                this.update();
                this.render();
                requestAnimationFrame(() => this.gameLoop());
            }

            restart() {
                document.getElementById('game-over').style.display = 'none';
                document.getElementById('game-over').innerHTML = '';
                this.initializeGame();
                if (this.soundSystem.musicEnabled) {
                    setTimeout(() => this.soundSystem.startBackgroundMusic(), 1000);
                }
            }
        }

        // Global game instance
        let game;

        // Start the game
        window.addEventListener('load', () => {
            document.addEventListener('click', () => {
                if (!window.gameStarted) {
                    game = new TetrisGame();
                    window.gameStarted = true;
                }
            }, { once: true });
            
            // Show appropriate start message
            const isMobile = isMobileViewport();
            const canvas = document.getElementById(isMobile ? 'mobile-canvas' : 'desktop-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.font = '20px Orbitron';
            ctx.textAlign = 'center';
            ctx.fillText(isMobile ? 'TAP TO START' : 'CLICK TO START', canvas.width/2, canvas.height/2);
        });
    </script>
</body>
</html>
